# Story 3.1: Smart Lead Capture Form Trigger

## Status
**Completed** âœ… - Superseded by Epic 4, Story 4.2 (Always-Visible Form)

## Story
**As a** potential customer,  
**I want** to provide my contact information after engaging with the 3D tool,  
**so that** I can receive quotes and move forward with ordering my custom mug design.

## Acceptance Criteria
1. Lead capture form appears automatically after user completes meaningful 3D engagement (uploads image OR customizes text AND changes color)
2. Form presentation feels natural and contextual, showing user's custom design as motivation
3. Form collects name, email, phone number, and project description with clear field validation
4. Mobile-optimized form layout with thumb-friendly input fields and submit button
5. GDPR-compliant consent checkboxes with links to privacy policy and data usage terms
6. Form can be dismissed but reappears after additional 3D engagement activities
7. Successful submission provides clear confirmation and next steps messaging

## Tasks / Subtasks
- [x] Create Lead Capture Form Component (AC: 3, 4, 5)
  - [x] Build form component with name, email, phone, project description fields
  - [x] Implement field validation with proper error messaging
  - [x] Add GDPR consent checkboxes with privacy policy links
  - [x] Ensure mobile-optimized layout with 44px+ touch targets
  - [x] Add form submission loading states and error handling
- [x] Implement Engagement Tracking Logic (AC: 1, 6)
  - [x] Track meaningful 3D engagement events (image upload, text + color change)
  - [x] Create engagement scoring system to trigger form display
  - [x] Implement form dismissal and re-trigger logic
  - [x] Add debounced engagement detection to prevent spam triggers
- [x] Create Form Trigger System (AC: 2, 7)
  - [x] Build contextual form overlay with design preview
  - [x] Implement smooth form animations and transitions  
  - [x] Create success confirmation modal with next steps
  - [x] Add form state management with Zustand integration
- [x] Integrate with Lead API Endpoint (AC: 7)
  - [x] Connect form submission to POST /api/leads endpoint
  - [x] Handle form validation errors from server response
  - [x] Implement retry logic for failed submissions
  - [x] Add analytics tracking for form events
- [x] Add Comprehensive Testing (Testing Standards)
  - [x] Create unit tests for form validation logic
  - [x] Test engagement tracking and trigger conditions
  - [x] Test mobile form interactions and accessibility
  - [x] Add integration tests for API form submission
  - [x] Test GDPR compliance and privacy policy links

## Dev Notes

### Previous Story Insights
From Story 2.5 completion, the existing infrastructure provides:
- **3D Engagement Tracking**: Design state management with Zustand store tracking all user interactions
- **Design State**: Complete Design interface with all customization data available for form context
- **Mobile Optimization**: Established 44px+ touch target patterns and responsive design
- **Analytics Integration**: Google Analytics event tracking patterns established
- **Visual Feedback System**: Toast notifications and user feedback patterns from existing components

### Tech Stack Requirements
[Source: architecture.md#Tech Stack]
- **Frontend Framework**: Next.js 14.0+ with App Router for form handling and API integration
- **State Management**: Zustand 4.4+ for lead capture form state and engagement tracking
- **Form Handling**: React Hook Form with Zod validation for type-safe form management
- **UI Components**: Tailwind CSS 3.3+ + Headless UI 1.7+ for form components and modal overlays
- **API Integration**: Next.js API routes for serverless lead capture endpoints
- **Analytics**: Google Analytics 4 for form interaction and conversion tracking

### Data Models Requirements
[Source: architecture.md#REST API Specification]
- **Lead Interface** (for form submission):
  ```typescript
  interface LeadInput {
    email: string;              // Required, format validation
    name: string;               // Required
    phone?: string;             // Optional, format validation
    projectDescription: string; // Required
    designId?: string;          // UUID, links to saved design
    source?: string;            // Traffic source tracking
    engagementLevel: 'low' | 'medium' | 'high'; // Based on 3D interaction
  }
  ```
- **Form State Interface**:
  ```typescript
  interface FormState {
    isVisible: boolean;
    isDismissed: boolean;
    dismissCount: number;
    lastEngagementTime: number;
    formData: Partial<LeadInput>;
    isSubmitting: boolean;
    errors: Record<string, string>;
  }
  ```
- **Engagement Tracking Interface**:
  ```typescript
  interface EngagementData {
    hasUploadedImage: boolean;
    hasCustomizedText: boolean;
    hasChangedColor: boolean;
    interactionCount: number;
    timeSpent: number;
    engagementScore: number;
  }
  ```

### Component Specifications Requirements
[Source: architecture.md#Mobile-First UI Components]
- **LeadCaptureForm Component**: Main form component with validation and submission
  - Props: `design: Design`, `onSubmit: (data: LeadInput) => void`, `onDismiss: () => void`
  - Features: Mobile-optimized layout, field validation, GDPR compliance, loading states
- **FormTriggerManager Component**: Manages form display logic based on engagement
  - Props: `engagementData: EngagementData`, `formState: FormState`
  - Features: Engagement scoring, trigger conditions, dismissal logic, re-trigger timing
- **DesignPreview Component**: Shows user's design in form context for motivation
  - Props: `design: Design`, `compact: boolean`
  - Features: Thumbnail view of customized mug, color/text/image preview
- **ConsentCheckbox Component**: GDPR-compliant consent handling
  - Props: `required: boolean`, `privacyPolicyUrl: string`, `onConsentChange: (accepted: boolean) => void`
  - Features: Privacy policy links, clear consent language, validation

### API Integration Requirements
[Source: architecture.md#REST API Specification]
- **POST /api/leads Endpoint Integration**:
  - Request body validation using LeadInput interface
  - Response handling for 201 success, 400 validation errors, 500 server errors
  - Retry logic for failed submissions with exponential backoff
  - Analytics event tracking for successful submissions
- **Form Validation Requirements**:
  - Email: Valid email format, required field
  - Name: Non-empty string, required field  
  - Phone: Optional, valid phone format if provided
  - Project Description: Required, minimum length validation
  - GDPR Consent: Required checkbox validation

### Engagement Tracking Logic
[Source: Epic 3.1 Requirements and existing design store patterns]
- **Meaningful Engagement Definition**:
  - High engagement: Image upload + text customization + color change
  - Medium engagement: (Image upload OR text customization) + color change
  - Low engagement: Any single customization action
- **Trigger Conditions**:
  - Initial trigger: After reaching medium or high engagement
  - Re-trigger: After dismissal, wait for additional engagement activity
  - Cooldown: Minimum 30 seconds between trigger attempts
- **Engagement Scoring Algorithm**:
  ```typescript
  const calculateEngagementScore = (data: EngagementData): number => {
    let score = 0;
    if (data.hasUploadedImage) score += 40;
    if (data.hasCustomizedText) score += 30;
    if (data.hasChangedColor) score += 20;
    score += Math.min(data.interactionCount * 2, 20);
    score += Math.min(data.timeSpent / 1000 / 10, 10); // 1 point per 10 seconds, max 10
    return Math.min(score, 100);
  };
  ```

### Mobile-First Design Requirements
[Source: architecture.md#Mobile-First UI Components]
- **Form Layout**: Optimized for mobile screens with proper spacing and typography
- **Touch Targets**: All interactive elements minimum 44px for thumb-friendly interaction  
- **Input Fields**: Large, clearly labeled with proper keyboard types (email, tel, text)
- **Submit Button**: Prominent, accessible, with loading states and success feedback
- **Modal Presentation**: Contextually placed with easy dismissal, respects safe areas
- **Keyboard Handling**: Form navigation with tab order, proper focus management

### GDPR Compliance Requirements
[Source: architecture.md#External APIs and Epic 3.1 requirements]
- **Consent Collection**: Clear, specific consent for marketing communications
- **Privacy Policy Links**: Links to privacy policy and data usage terms
- **Data Processing Transparency**: Clear explanation of how data will be used
- **Consent Validation**: Form cannot submit without explicit consent
- **Opt-out Options**: Clear information about unsubscribe options

### File Structure and Locations
[Source: Project Structure and established patterns]
- **New Components**:
  - `app/components/LeadCaptureForm.tsx` - Main form component
  - `app/components/LeadCaptureForm.test.tsx` - Form component tests
  - `app/components/FormTriggerManager.tsx` - Engagement-based form trigger logic  
  - `app/components/FormTriggerManager.test.tsx` - Trigger manager tests
  - `app/components/DesignPreview.tsx` - Compact design preview for form context
  - `app/components/DesignPreview.test.tsx` - Design preview tests
  - `app/components/ConsentCheckbox.tsx` - GDPR consent component
  - `app/components/ConsentCheckbox.test.tsx` - Consent checkbox tests
- **Enhanced Store**:
  - `app/components/3d/store/designStore.ts` - Add engagement tracking and form state
- **API Endpoints**:  
  - `app/api/leads/route.ts` - Lead capture endpoint (already exists per architecture.md)
  - `app/api/leads/route.test.ts` - API endpoint tests

### Integration with Existing Systems
[Source: Stories 1.1-2.5 completion and design store patterns]
- **Design Store Integration**: Use existing Zustand store to access current design state and add engagement tracking
- **3D Component Integration**: Hook into existing MugModel and Scene components for engagement events
- **Analytics Integration**: Use established Google Analytics patterns for form interaction tracking
- **Visual Feedback Integration**: Use existing toast notification patterns for form success/error states
- **Mobile UI Integration**: Follow established mobile-first patterns from previous stories

### Testing
[Source: architecture.md#Tech Stack and established testing patterns]
- **Testing Framework**: Vitest 1.0+ with @testing-library/react 14.0+ for component testing
- **Test Location**: Create test files adjacent to components as `ComponentName.test.tsx`
- **Testing Standards**: Follow established patterns from Stories 1.1-2.5 for React component testing
- **Testing Frameworks**: Vitest for test runner, @testing-library/react for component testing, JSdom for DOM simulation

#### Testing Requirements for Story 3.1
- **Form Testing**: Test form validation, submission, error handling, and user interactions
- **Engagement Testing**: Test trigger conditions, dismissal logic, and re-trigger scenarios  
- **Mobile Testing**: Test touch interactions, responsive layout, and accessibility features
- **API Testing**: Test form submission to lead capture endpoint with various scenarios
- **Analytics Testing**: Test form interaction event tracking and conversion events

#### Specific Test Cases
- Test engagement tracking logic and trigger conditions for different interaction patterns
- Validate form field validation with various input scenarios (invalid email, missing fields, etc.)
- Test mobile form layout and touch interactions across different screen sizes
- Test GDPR consent checkbox validation and privacy policy link functionality
- Test form dismissal and re-trigger logic with different engagement scenarios
- Test API integration with successful submission, validation errors, and server errors
- Test design preview display with different design configurations
- Test accessibility features including keyboard navigation and screen reader compatibility
- Test form state persistence and recovery after dismissals
- Test analytics event firing for form interactions and successful submissions

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-29 | v1.0 | Initial story creation for Smart Lead Capture Form Trigger with comprehensive technical context from architecture.md, Epic 3.1 requirements, and insights from completed Stories 1.1-2.5 | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
GitHub Copilot (James) - Full Stack Developer Agent v1.0

### Debug Log References
No significant debug issues encountered. TypeScript compilation passed, components integrate cleanly with existing codebase. Minor issue resolved: Added missing 'use client' directive to Navigation.tsx during build validation.

### Completion Notes List
- **Task 1 - Lead Capture Form Component**: Successfully implemented `LeadCaptureForm.tsx` with full validation, GDPR compliance, mobile-optimized layout (44px+ touch targets), and comprehensive error handling. Includes `ConsentCheckbox.tsx` and `DesignPreview.tsx` helper components.
- **Task 2 - Engagement Tracking Logic**: Enhanced `designStore.ts` with engagement tracking interfaces, scoring algorithm (image upload: 40pts, text: 30pts, color: 20pts), and form state management. Integrated tracking into existing `MugDesigner.tsx` color/text handlers.
- **Task 3 - Form Trigger System**: Implemented `FormTriggerManager.tsx` with contextual overlay, smooth animations, success confirmation, and full Zustand integration. Added to main `page.tsx` for global form triggering.
- **Task 4 - API Integration**: Connected form to existing `/api/leads` endpoint with proper error handling, retry logic, and Google Analytics event tracking for form interactions (submit, dismiss, error).
- **Task 5 - Comprehensive Testing**: Created full test suites for all components (`*.test.tsx`) covering form validation, engagement logic, mobile interactions, API integration, and GDPR compliance using Vitest + Testing Library.

### File List
**New Components Created:**
- `app/components/LeadCaptureForm.tsx` - Main lead capture form with validation and submission
- `app/components/LeadCaptureForm.test.tsx` - Comprehensive form component tests
- `app/components/ConsentCheckbox.tsx` - GDPR-compliant consent checkbox component
- `app/components/ConsentCheckbox.test.tsx` - Consent checkbox component tests
- `app/components/DesignPreview.tsx` - Compact design preview for form context
- `app/components/DesignPreview.test.tsx` - Design preview component tests
- `app/components/FormTriggerManager.tsx` - Engagement-based form trigger manager
- `app/components/FormTriggerManager.test.tsx` - Form trigger manager tests

**Modified Files:**
- `app/components/3d/store/designStore.ts` - Added engagement tracking, form state management, and trigger logic
- `app/components/MugDesigner.tsx` - Integrated engagement tracking for color and text changes
- `app/components/3d/ImageUpload.tsx` - Added engagement tracking import (automatic via updateDesign)
- `app/components/Navigation.tsx` - Fixed missing 'use client' directive
- `app/page.tsx` - Integrated FormTriggerManager for global form triggering

**Dependencies Added:**
- `react-hook-form` - Form handling library (planned but implemented with vanilla React for simplicity)
- `@hookform/resolvers` - Form validation resolvers (planned but used custom validation)
- `zod` - Schema validation library (planned but used custom validation)
- `@testing-library/user-event` - Enhanced user interaction testing

## Supersession Notice

**Date:** 2025-09-30
**Superseded By:** Epic 4, Story 4.2 (Always-Visible Lead Capture Form)
**Reason:** Strategic pivot to single-page minimalist UX design

This story's engagement-based trigger logic is removed in Epic 4. The form is now always visible on page load, eliminating the need for FormTriggerManager and engagement scoring algorithms.

**Implementation Status:**
- **Preserved:** `LeadCaptureForm.tsx`, form validation, GDPR compliance, API integration
- **Removed:** `FormTriggerManager.tsx`, engagement tracking logic, trigger conditions
- **Simplified:** Design store engagement state management

The core form functionality and backend integration remain unchanged. Epic 4 focuses on UX refactoring while maintaining all business logic.

---

## QA Results

*This section will be populated by the QA agent after story completion*

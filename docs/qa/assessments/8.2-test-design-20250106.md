# Test Design: Story 8.2 - Image-to-Image Enhancement & Combined Workflow

**Date**: 2025-01-06
**Designer**: Quinn (Test Architect)
**Story**: 8.2 - Image-to-Image Enhancement & Combined Workflow
**Status**: Proactive Test Design (Pre-Implementation)

---

## Test Strategy Overview

- **Total test scenarios**: 47
- **Unit tests**: 18 (38%)
- **Integration tests**: 22 (47%)
- **E2E tests**: 7 (15%)
- **Priority distribution**:
  - P0 (Critical): 15 tests (32%)
  - P1 (High): 20 tests (43%)
  - P2 (Medium): 10 tests (21%)
  - P3 (Low): 2 tests (4%)

### Test Level Distribution Rationale

**Unit (38%)**: Focus on isolated logic - mode switching, state management, validation
**Integration (47%)**: Emphasize component interactions - mode changes trigger correct UI, API calls integrate properly
**E2E (15%)**: Validate critical user journeys across all three modes

**Risk-Based Focus**: TECH-003 (Base64 encoding) requires extensive integration testing with various image sizes.

---

## Risk Coverage Matrix

**Mapping to Risk Profile** (from 8.2-risk-20250106.md):

| Risk ID | Risk Title | Score | Test Coverage |
|---------|------------|-------|---------------|
| **TECH-003** | Base64 encoding large images | 9 (CRITICAL) | 8.2-INT-003, 8.2-INT-004, 8.2-INT-005, 8.2-E2E-002 |
| **PERF-003** | Slower performance | 6 (HIGH) | 8.2-INT-008, 8.2-E2E-003 |
| **TECH-004** | Complex 3-mode state management | 6 (HIGH) | 8.2-UNIT-007 through 8.2-UNIT-012, 8.2-INT-012 through 8.2-INT-015 |
| **DATA-001** | Loss of original image | 4 (MEDIUM) | 8.2-UNIT-013, 8.2-INT-016 |
| **BUS-002** | Mode confusion | 4 (MEDIUM) | 8.2-E2E-001, 8.2-E2E-004 |

**Critical Risk (TECH-003) Mitigation Strategy**:
Must validate image compression, payload limits, and error handling across multiple test scenarios.

---

## Test Scenarios by Acceptance Criteria

### AC1: Users can select image-to-image mode

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk |
|----|-------|----------|------|---------------|------|
| 8.2-UNIT-001 | Unit | P0 | `setGenerationMode('image-to-image')` updates state correctly | Pure state logic test | - |
| 8.2-INT-001 | Integration | P0 | Mode toggle UI reflects selected mode visually | Component + state interaction | - |
| 8.2-E2E-001 | E2E | P1 | User can switch to image-to-image mode and see base image upload UI | Critical user journey | BUS-002 |

**Given-When-Then (E2E-001)**:
- **Given**: User is on the mug customization page with text-to-image mode active
- **When**: User clicks "Image-to-Image" mode toggle button
- **Then**:
  - Mode toggle highlights "Image-to-Image" option
  - Base image upload UI becomes visible
  - Text-to-image prompt UI remains visible
  - Previous mode state is cleared appropriately

---

### AC2: Uploaded base image + prompt generates enhanced texture

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk |
|----|-------|----------|------|---------------|------|
| 8.2-UNIT-002 | Unit | P0 | `generateFromImage` sets `isGenerating = true` during API call | Async state management | - |
| 8.2-UNIT-003 | Unit | P0 | `generateFromImage` sets `previewImageUrl` on success | State update logic | - |
| 8.2-UNIT-004 | Unit | P0 | `generateFromImage` sets `generationError` when baseImage missing | Validation logic | - |
| 8.2-UNIT-005 | Unit | P1 | `setBaseImageForEnhancement` stores image without applying to mug | State isolation | DATA-001 |
| 8.2-INT-002 | Integration | P0 | API route accepts `mode: 'image-to-image'` with base image | API integration | TECH-003 |
| 8.2-INT-003 | Integration | P0 | API route compresses images >1024px before sending to Google AI Studio | Performance optimization | TECH-003 |
| 8.2-INT-004 | Integration | P0 | API route returns 400 when base image exceeds 5MB | Payload validation | TECH-003 |
| 8.2-INT-005 | Integration | P0 | API route returns 400 when base image is invalid format | Format validation | TECH-003 |
| 8.2-INT-006 | Integration | P0 | API route successfully calls Google AI Studio with image-to-image payload | External API integration | - |
| 8.2-INT-007 | Integration | P0 | API route returns enhanced image URL on success | Response handling | - |
| 8.2-INT-008 | Integration | P1 | Generation completes within 10 seconds for typical images (1-2MB) | Performance target | PERF-003 |
| 8.2-E2E-002 | E2E | P0 | User uploads 3MB image, enters prompt, generates enhanced texture | Critical path with realistic payload | TECH-003 |
| 8.2-E2E-003 | E2E | P1 | User uploads 5MB image, sees error message about size limit | Edge case validation | TECH-003, PERF-003 |

**Given-When-Then (E2E-002)**:
- **Given**: User is in image-to-image mode
- **When**:
  - User uploads a 3MB JPEG base image
  - User enters prompt "make it watercolor style"
  - User clicks "Generate Enhanced Image"
- **Then**:
  - Loading spinner displays (isGenerating = true)
  - API route compresses image if needed
  - Request completes within 10 seconds
  - Preview shows enhanced image
  - Base image remains in state for regeneration

---

### AC3: Mode toggle clearly indicates active generation method

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk |
|----|-------|----------|------|---------------|------|
| 8.2-UNIT-006 | Unit | P1 | Mode toggle renders three options (Manual, Text-to-Image, Image-to-Image) | Component rendering | - |
| 8.2-INT-009 | Integration | P0 | Clicking mode toggle changes `generationMode` in store | User interaction → state | - |
| 8.2-INT-010 | Integration | P0 | Active mode has visual highlight (different background/color) | UI state feedback | BUS-002 |
| 8.2-INT-011 | Integration | P1 | Inactive modes appear dimmed/grayed out | Visual distinction | BUS-002 |
| 8.2-E2E-004 | E2E | P1 | User switches between all three modes and each is clearly indicated | User experience validation | BUS-002 |

**Given-When-Then (E2E-004)**:
- **Given**: User is on mug customization page
- **When**: User cycles through Manual → Text-to-Image → Image-to-Image → Manual
- **Then**:
  - Each mode is clearly highlighted when active
  - Mode-specific UI appears for each selection
  - User can distinguish which mode is currently active at a glance

---

### AC4: Preview shows generated image before application to mug

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk |
|----|-------|----------|------|---------------|------|
| 8.2-UNIT-007 | Unit | P0 | `setPreviewImage(url)` stores preview without applying to mug | State isolation | DATA-001 |
| 8.2-UNIT-008 | Unit | P0 | `applyPreviewToMug()` copies preview to `uploadedImageUrl` | State transfer logic | - |
| 8.2-UNIT-009 | Unit | P1 | `applyPreviewToMug()` clears `previewImageUrl` after apply | Cleanup logic | - |
| 8.2-INT-012 | Integration | P0 | Preview card displays when `previewImageUrl` is set | Component state binding | - |
| 8.2-INT-013 | Integration | P0 | "Apply to Mug" button calls `applyPreviewToMug` | User action → state change | - |
| 8.2-INT-014 | Integration | P1 | Preview card hides when `previewImageUrl` is undefined | Conditional rendering | - |
| 8.2-E2E-005 | E2E | P0 | User generates image, sees preview, clicks "Apply to Mug", texture updates on 3D model | Complete preview workflow | - |

**Given-When-Then (E2E-005)**:
- **Given**: User has generated an enhanced image in image-to-image mode
- **When**:
  - Preview card displays with generated image
  - User clicks "Apply to Mug" button
- **Then**:
  - `previewImageUrl` copied to `uploadedImageUrl`
  - 3D mug model updates with new texture
  - Preview card disappears
  - User sees enhanced texture on mug

---

### AC5: Users can regenerate with different prompts without re-uploading image

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk |
|----|-------|----------|------|---------------|------|
| 8.2-UNIT-010 | Unit | P0 | `generateFromImage` reuses existing `baseImageForEnhancement` | State reuse logic | - |
| 8.2-UNIT-011 | Unit | P1 | Base image persists in state after first generation | State persistence | - |
| 8.2-INT-015 | Integration | P0 | "Regenerate" button calls `generateFromImage` with same base image | User action → regeneration | - |
| 8.2-INT-016 | Integration | P1 | User can change prompt and regenerate without re-uploading | Workflow efficiency | - |
| 8.2-E2E-006 | E2E | P0 | User uploads image once, generates multiple variations with different prompts | Key workflow efficiency | DATA-001 |

**Given-When-Then (E2E-006)**:
- **Given**: User uploaded base image "company-logo.png" and generated first enhanced version
- **When**:
  - User clicks "Regenerate"
  - User changes prompt from "make vibrant" to "make minimalist"
  - User clicks "Generate Enhanced Image"
- **Then**:
  - Base image NOT re-uploaded (reuses from state)
  - New generation starts with same base image + new prompt
  - Preview updates with new result
  - User can repeat process indefinitely without re-uploading

---

### AC6: All three modes work seamlessly

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk |
|----|-------|----------|------|---------------|------|
| 8.2-UNIT-012 | Unit | P0 | `setGenerationMode` clears mode-specific state when switching | State isolation between modes | TECH-004 |
| 8.2-INT-017 | Integration | P0 | Switching from manual to text-to-image clears appropriate state | Mode transition | TECH-004 |
| 8.2-INT-018 | Integration | P0 | Switching from text-to-image to image-to-image clears appropriate state | Mode transition | TECH-004 |
| 8.2-INT-019 | Integration | P0 | Switching from image-to-image to manual clears appropriate state | Mode transition | TECH-004 |
| 8.2-INT-020 | Integration | P1 | Manual upload works exactly as before Story 8.2 (regression test) | Backward compatibility | - |
| 8.2-INT-021 | Integration | P1 | Text-to-image mode from 8.1 remains functional (regression test) | Backward compatibility | - |
| 8.2-INT-022 | Integration | P1 | User can use all three modes in sequence without errors | Integration stability | - |
| 8.2-E2E-007 | E2E | P0 | User uploads manually, then generates text-to-image, then image-to-image in one session | Complete mode integration | TECH-004 |

**State Clearing Logic (UNIT-012)**:
```typescript
// When switching TO manual:
- Clear: baseImageForEnhancement, previewImageUrl
- Keep: uploadedImageUrl (current mug texture)

// When switching TO text-to-image:
- Clear: baseImageForEnhancement
- Keep: previewImageUrl (if user wants to see last generation)

// When switching TO image-to-image:
- Clear: previewImageUrl
- Keep: baseImageForEnhancement (if exists)
```

**Given-When-Then (E2E-007)**:
- **Given**: User starts with blank mug
- **When**: User executes following sequence:
  1. Switch to Manual mode → upload "pattern.png" → applies to mug
  2. Switch to Text-to-Image → generate "abstract art" → applies to mug
  3. Switch to Image-to-Image → upload base image → generate "watercolor" → applies to mug
- **Then**:
  - All three workflows complete successfully
  - No state conflicts or errors
  - Each mode behaves independently
  - Mug texture updates correctly after each application

---

### AC7: Existing 3D controls remain functional

#### Scenarios

| ID | Level | Priority | Test | Justification | Risk |
|----|-------|----------|------|---------------|------|
| 8.2-INT-023 | Integration | P0 | Rotation controls work in all three modes | Regression test | - |
| 8.2-INT-024 | Integration | P0 | Color picker works in all three modes | Regression test | - |
| 8.2-INT-025 | Integration | P0 | Text overlay works in all three modes | Regression test | - |
| 8.2-INT-026 | Integration | P1 | Camera controls work in all three modes | Regression test | - |
| 8.2-INT-027 | Integration | P1 | Reset button works in all three modes | Regression test | - |

**Given-When-Then (INT-023)**:
- **Given**: User is in any of the three modes (manual, text-to-image, image-to-image)
- **When**: User drags to rotate the 3D mug
- **Then**: Mug rotates smoothly without interfering with mode-specific UI

---

## Edge Cases & Negative Tests

### Edge Case Testing

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 8.2-UNIT-014 | Unit | P2 | Base image is null/undefined when calling `generateFromImage` | Defensive programming |
| 8.2-UNIT-015 | Unit | P2 | Prompt is empty when calling `generateFromImage` | Input validation |
| 8.2-UNIT-016 | Unit | P2 | User switches modes rapidly (state race condition) | Concurrency edge case |
| 8.2-INT-028 | Integration | P2 | Base image is corrupted/malformed | Error handling |
| 8.2-INT-029 | Integration | P2 | API returns 500 error during image-to-image generation | External failure |
| 8.2-INT-030 | Integration | P2 | Network timeout during base image upload | Network failure |
| 8.2-INT-031 | Integration | P2 | User uploads image exactly 5MB (boundary condition) | Boundary testing |
| 8.2-INT-032 | Integration | P3 | User uploads extremely small image (10x10px) | Unusual input |
| 8.2-INT-033 | Integration | P2 | User uploads animated GIF as base image | Format edge case |

### Negative Testing

| ID | Level | Priority | Test | Expected Behavior |
|----|-------|----------|------|-------------------|
| 8.2-NEG-001 | Integration | P1 | Upload non-image file (PDF) in image-to-image mode | Error: "Invalid image format" |
| 8.2-NEG-002 | Integration | P1 | Click "Generate" in image-to-image without uploading base image | Error: "Please upload a base image first" |
| 8.2-NEG-003 | Integration | P1 | Prompt exceeds 500 characters | Error: "Prompt must be 3-500 characters" |
| 8.2-NEG-004 | Integration | P2 | Base image is SVG (unsupported format) | Error: "Please use JPEG, PNG, or WebP" |
| 8.2-NEG-005 | Integration | P2 | Click "Apply to Mug" when preview is empty | Button disabled or no-op |

---

## Test Data Requirements

### Image Test Assets

**Required Test Images** (create before testing):

1. **small-image.jpg** (100KB, 512x512) - Fast processing test
2. **medium-image.png** (1.5MB, 1024x1024) - Typical use case
3. **large-image.jpg** (3MB, 2048x2048) - Compression test
4. **oversized-image.png** (6MB, 4096x4096) - Size limit test
5. **portrait-image.jpg** (800KB, 600x800) - Aspect ratio test
6. **landscape-image.jpg** (800KB, 800x600) - Aspect ratio test
7. **transparent-bg.png** (500KB, 1024x1024) - Transparency handling
8. **company-logo.png** (200KB, 512x512) - Real-world use case
9. **corrupted.jpg** (Malformed file) - Error handling test
10. **boundary-5mb.jpg** (Exactly 5MB) - Boundary condition test

### Prompt Test Data

**Effective Prompts** (positive cases):
- "make it watercolor style"
- "add vibrant colors and patterns"
- "transform to minimalist black and white"
- "create abstract geometric version"

**Edge Case Prompts**:
- "" (empty - should error)
- "a" (too short - should error)
- 501-character string (too long - should error)
- "✨🎨🖼️" (emoji only - should work or graceful error)

### API Response Mocks

**Mock Responses for Integration Tests**:

```typescript
// Success response
{
  candidates: [{
    content: {
      parts: [{
        inlineData: {
          mimeType: "image/png",
          data: "base64_encoded_enhanced_image_data"
        }
      }]
    }
  }]
}

// Error responses
// 400: Invalid base image
// 429: Rate limit exceeded (from Story 8.3)
// 500: Google AI Studio internal error
// 503: Service unavailable
```

---

## Recommended Execution Order

### Phase 1: P0 Unit Tests (Fail Fast)
**Duration**: ~15 minutes
**Tests**: 8.2-UNIT-001 through 8.2-UNIT-012 (12 tests)

**Purpose**: Validate core logic before integration testing.

**Order**:
1. State management (UNIT-001, UNIT-002, UNIT-003)
2. Validation logic (UNIT-004, UNIT-014, UNIT-015)
3. Mode switching (UNIT-012)
4. Preview logic (UNIT-007, UNIT-008, UNIT-009)
5. Regeneration (UNIT-010, UNIT-011)

### Phase 2: P0 Integration Tests (Critical Paths)
**Duration**: ~45 minutes
**Tests**: 8.2-INT-002 through 8.2-INT-027 (select P0 only - 15 tests)

**Purpose**: Validate component interactions and API integration.

**Order by Risk**:
1. **TECH-003 Risk**: INT-002, INT-003, INT-004, INT-005 (image encoding)
2. **API Integration**: INT-006, INT-007
3. **Mode Switching**: INT-009, INT-017, INT-018, INT-019
4. **Preview Workflow**: INT-012, INT-013
5. **Regression**: INT-020, INT-021, INT-023, INT-024, INT-025

### Phase 3: P0 E2E Tests (User Journeys)
**Duration**: ~30 minutes
**Tests**: 8.2-E2E-001, 8.2-E2E-002, 8.2-E2E-005, 8.2-E2E-006, 8.2-E2E-007 (5 tests)

**Purpose**: Validate end-to-end user workflows.

**Order**:
1. E2E-001: Basic mode switching
2. E2E-002: Image-to-image with realistic payload (TECH-003)
3. E2E-005: Preview workflow
4. E2E-006: Regeneration workflow
5. E2E-007: All three modes in sequence

### Phase 4: P1 Tests
**Duration**: ~1 hour
**Tests**: All P1 priority tests (20 tests)

**Run after P0 passes**.

### Phase 5: P2/P3 Tests (Time Permitting)
**Duration**: ~45 minutes
**Tests**: Edge cases, negative tests, unusual inputs

**Run before release or as regression suite**.

---

## Test Environment Requirements

### Prerequisites

1. **Story 8.1 deployed and functional** (text-to-image working)
2. **Story 8.3 deployed** (rate limiting active - optional but recommended)
3. **Google AI Studio API key configured** (`GOOGLE_AI_STUDIO_API_KEY`)
4. **Test image assets available** (see Test Data Requirements)

### Browser Requirements

- **Chrome** (latest) - Primary test browser
- **Firefox** (latest) - Secondary
- **Safari** (latest) - macOS testing
- **Edge** (latest) - Windows testing

**Critical**: Canvas API support required for image compression.

### Performance Baselines

From Story 8.1 + Epic 8 requirements:

- **Text-to-image**: 2-4 seconds (baseline)
- **Image-to-image target**: <10 seconds (AC requirement)
- **UI responsiveness**: <100ms for mode switching
- **Image compression**: <2 seconds for 5MB image

---

## Test Automation Strategy

### Recommended Automation Level

| Test Level | Total | Automate | Manual | Automation % |
|------------|-------|----------|--------|--------------|
| Unit | 18 | 18 | 0 | 100% |
| Integration | 27 | 24 | 3 | 89% |
| E2E | 7 | 5 | 2 | 71% |
| **Total** | **52** | **47** | **5** | **90%** |

### Manual Testing (5 tests)

**Why Manual**:
1. **E2E-004** (Mode visual indication) - Subjective UX validation
2. **INT-031** (Exactly 5MB boundary) - Requires precise file creation
3. **INT-008** (Performance timing) - Real network conditions needed
4. **INT-033** (Animated GIF) - Visual validation needed
5. **Final Smoke Test** - All three modes end-to-end in prod environment

---

## Coverage Gaps Analysis

### Acceptance Criteria Coverage

| AC | Tests | Coverage |
|----|-------|----------|
| AC1 | 3 tests | ✅ Full |
| AC2 | 13 tests | ✅ Full |
| AC3 | 5 tests | ✅ Full |
| AC4 | 7 tests | ✅ Full |
| AC5 | 5 tests | ✅ Full |
| AC6 | 8 tests | ✅ Full |
| AC7 | 5 tests | ✅ Full |

**Total AC Coverage**: 7/7 (100%) ✅

### Risk Coverage

| Risk ID | Tests | Mitigation |
|---------|-------|------------|
| TECH-003 (Critical) | 4 tests | ✅ Comprehensive |
| PERF-003 (High) | 2 tests | ✅ Adequate |
| TECH-004 (High) | 8 tests | ✅ Comprehensive |
| DATA-001 (Medium) | 3 tests | ✅ Adequate |
| BUS-002 (Medium) | 3 tests | ✅ Adequate |

**Risk Coverage**: 5/5 high-priority risks covered ✅

### Potential Gaps (Future Consideration)

1. **Accessibility**: No ARIA/screen reader tests (consider for future story)
2. **Mobile**: No mobile-specific tests (touch interactions)
3. **Concurrent Users**: No load testing (multiple users generating simultaneously)
4. **Long-Running Sessions**: No memory leak detection over time
5. **Offline Behavior**: No tests for network offline scenarios

**Recommendation**: Address in future stories or as technical debt if needed.

---

## Success Criteria

### Definition of "Test Suite Complete"

- [x] All 7 ACs have test coverage
- [x] Critical risk (TECH-003) has multiple test scenarios
- [x] All P0 tests defined and documented
- [x] Test data requirements specified
- [x] Execution order prioritized
- [x] Automation strategy defined

### Definition of "Story Ready to Deploy"

**Must Pass**:
- ✅ All P0 unit tests pass (12 tests)
- ✅ All P0 integration tests pass (15 tests)
- ✅ All P0 E2E tests pass (5 tests)
- ✅ Critical risk tests pass (TECH-003: 4 tests)
- ✅ Regression tests pass (Story 8.1 functionality intact)

**Should Pass**:
- ✅ All P1 tests pass (20 tests)
- ✅ Manual smoke test successful

**Can Defer** (if time-constrained):
- P2/P3 tests (12 tests) - Run as regression suite

---

## Test Metrics to Track

### During Development

1. **Test Pass Rate**: Target >95% on first run
2. **P0 Test Execution Time**: Target <90 minutes total
3. **Code Coverage**: Target >80% for new code
4. **Bug Detection Rate**: Tests find bugs before manual QA

### Post-Deployment

1. **Regression Test Suite**: All 47 tests pass in prod
2. **Performance Metrics**:
   - Image-to-image generation time: P90 <10s
   - Mode switch responsiveness: P95 <100ms
3. **Error Rates**:
   - Image upload failures: <5%
   - API generation failures: <5%

---

## Integration with Quality Gate

### Test Design Summary for Gate File

```yaml
test_design:
  scenarios_total: 47
  by_level:
    unit: 18
    integration: 27
    e2e: 7
  by_priority:
    p0: 32
    p1: 20
    p2: 10
    p3: 2
  coverage_gaps: []
  risk_coverage:
    - TECH-003: 4 tests (Critical)
    - PERF-003: 2 tests (High)
    - TECH-004: 8 tests (High)
    - DATA-001: 3 tests (Medium)
    - BUS-002: 3 tests (Medium)
  automation_rate: 90%
```

---

## Appendix: Test Scenario Quick Reference

### By Priority

**P0 (32 tests)**: Critical path, must pass before deployment
**P1 (20 tests)**: High priority, should pass before deployment
**P2 (10 tests)**: Medium priority, run as time permits
**P3 (2 tests)**: Low priority, nice to have

### By Test Level

**Unit (18 tests)**: Fast, isolated logic
**Integration (27 tests)**: Component interactions, API calls
**E2E (7 tests)**: Complete user journeys

### By Risk Mitigation

**TECH-003** (4 tests): Base64 image encoding critical risk
**TECH-004** (8 tests): State management complexity
**PERF-003** (2 tests): Performance degradation
**DATA-001** (3 tests): Data loss prevention
**BUS-002** (3 tests): User confusion mitigation

---

## Next Steps for Developer

1. **Review this test design** before implementing Story 8.2
2. **Create test image assets** (see Test Data Requirements)
3. **Implement tests in parallel with features** (TDD approach recommended)
4. **Run P0 tests first** (fail fast on critical paths)
5. **Address TECH-003 mitigation** (image compression) early in implementation
6. **Validate against risk profile** (8.2-risk-20250106.md)

---

**Test Design Complete** ✅

**Reference**: This document guides development of Story 8.2 test suite. Use in conjunction with:
- Risk Profile: `docs/qa/assessments/8.2-risk-20250106.md`
- Story Spec: `docs/stories/8.2.image-to-image-enhancement-combined-workflow.md`

**Questions?** Contact Quinn (Test Architect) for clarification.
